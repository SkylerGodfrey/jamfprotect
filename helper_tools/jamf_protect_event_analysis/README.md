# Jamf Protect Event Analysis

Resources contained within this repository can be used to help optimize the monitoring and/or prevention of system, application and user activity by Jamf Protect.

This event analysis tool has been updated to introduce compatibility with the `protectctl diagnostics` command from Jamf Protect, supporting log files generated by that tool that can be parsed using the `-i` input argument.  See the [**Jamf Protect Documentation**](https://learn.jamf.com/bundle/jamf-protect-documentation/page/About_Jamf_Protect.html#ariaid-title3) for more information on using the `protectctl diagnostics` command.

## Customizing monitoring and detection

There are certain scenarios and use-cases where high velocity, expected activity in trusted locations on Mac endpoints can be ignored from monitoring and detection to ensure only the necessary analysis (using system resources) is completed.  

The [**Exceptions**](https://docs.jamf.com/jamf-protect/documentation/Exceptions.html) feature in Jamf Protect can be used to limit or ignore such activity, preserving the endpoint's system resources and the end-user's experience.

It is **strongly recommended** to only ignore activity on Mac endpoints using the Exceptions feature that is trusted and expected for the host user.

## Using the _jp_event_analysis_ helper tool

The _jp_event_analysis_ tool can be used on a Mac endpoint to surface activity that would normally be monitored by Jamf Protect, supporting the Threat Prevention, Analytics (behavioral analysis) and Unified Log filtering features.

Output generated by the tool will indicate the most analyzed activity per feature, providing the required data points about the activity to build Exceptions rules that will cause Jamf Protect to ignore the activity for monitoring and detection.

The script currently supports the following monitors: 

* Threat Feed
* Process
* File
* Unified Logging
* Telemetry

The **example output** shown below of the _jp_event_analysis_ tool shows the tool surfacing process activity (enabled with the _-m Process_ arg) and with a summary output requested (enabled with the _-s_ arg).  See the help page of this tool below or built-in the man page for more options.

```
❯ source ~/Documents/py3-jp/bin/activate
py3-jp ❯ ./jp_event_analysis.py -m Process -s
Running Process log stream for the next 60 seconds...
Top 10 Count for Process Monitor
 count    pid                            parent                              args
     3  37251                  Parent Process 1                         Arguments
     2  37738                  Parent Process 2                         Arguments
     1  37590                  Parent Process 3                         Arguments

Unique Codesigning Info
                                             Binary                  Signing Info
  /Applications/Parent Process 1.app/Contents/MacO...                  XXXXXXXXXX
  /Users/username/Library/Application Support/Proc...                  XXXXXXXXXX
  /Applications/Parent Process 3.app/Contents/MacO...         com.company.process

See excel spreadsheet for full report.
```

## Requirements

- [x] Verbose logging must be enabled in the system's plan in Jamf Protect
- [x] Python3 (see [requirements.txt](./requirements.txt))

## Getting Started

1. Clone JamfProtect GitHub repo

    `git clone https://github.com/jamf/jamfprotect.git`

2. Goto Jamf Protect Event Analysis folder

    `cd jamfprotect/helper_tools/jamf_protect_event_analysis`

3. Create a python virtual environment

    `python3 -m venv ~/Documents/py3-jp`

4. Activate python virtual environment

    `source ~/Documents/py3-jp/bin/activate`

5. Install Python3 requirements

    `pip3 install -r requirements.txt`

## How To

```
./jp_event_analysis.py -h
usage: jp_event_analysis.py [-h] -m MONITOR [-i INPUT] [-o OUTPUT] [-s]

Given a monitor, count events in Unified Logs.

optional arguments:
  -h, --help            show this help message and exit
  -m MONITOR, --monitor MONITOR
                        monitor Name to be used when parsing the logs
  -i INPUT, --input INPUT
                        path to JSON file to be parsed
  -o OUTPUT, --output OUTPUT
                        path to save xlsx
  -s, --summary         print summary
```

> **Note** 
> Only one monitor can be parsed at a time.

For this script you can either read the output of log show/stream results or the script will run a log stream for 60 seconds. If you are inputting from external results you must run the following on the machine when gathering the log file:

```
log stream --info --debug --style json --timeout <desired time> --predicate 'subsystem BEGINSWITH "com.jamf.protect" AND category == "<MonitorName>"' > log_file.json
```

## Self Service

Included is a [shell script](./jp_event_analysis_self_service.sh) which can be uploaded to Jamf Pro and run from Self Service. This script does the following in a temporary folder:

- Creates jp_event_analysis.py 
- Configures a python virtual environment
- Gathers logs from the following monitors
    - ExecAuth
    - Process
    - File
    - UnifiedLogging
    - Telemetry
- Archives the logs
- Cleans up

## Please note that all resources contained within this repository are provided as-is and are not officially supported by Jamf Support.
